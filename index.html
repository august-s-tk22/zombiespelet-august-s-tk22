<!DOCTYPE html>
<head>
    <link rel="stylesheet" href="./style.css">
</head>
<body>
    <script src="https://spelprogrammering.nu/simple.js">
      
        var zombies = [];
        var i = 0;
      
        // Radius = hitbox
        var player = { x: totalWidth/2, y: totalHeight/2, speed: 15, radius: 35, width: 32*3, height: 32*3 };
      
        var keys = {};
        document.addEventListener("keydown", function(event) {
          keys[event.key] = true;
        });
        document.addEventListener("keyup", function(event) {
          keys[event.key] = false;
        });
        function keyDown(key) {
          return keys[key] === true;
        }
      
        // Zombies amount
        // Radius = hitbox
        var i = 0; 
        while (i < 5)
        {
          zombies.push({
            x: random(totalWidth),
            y: random(totalHeight),
            speed: random(3,7),
            radius: 35,
            width: 32*3,
            height: 32*3
          });
      
          i ++;
        }
    
        // Radius = hitbox
        // Size of zombie
        var zombie = {x:random(totalWidth), y:random(totalHeight), speed: random(1,5), radius: 35, width: 32*3, height: 32*3};

        var weapon = {x: random(totalWidth), y: random(totalHeight), active: false};

        var lastUsedTime = 0;
      
        let themeMusic;
        
        function update()
{
        if (!themeMusic) {
          themeMusic = new Audio("./media/zombiesong.mp3");
          themeMusic.loop = true; // Add loop to continuously play the music
          themeMusic.play();
        }

        clearScreen();

        // Update player position via keyboard
        if (keyDown("w")) {
          player.y -= player.speed;
        }
        if (keyDown("s")) {
          player.y += player.speed;
        }
        if (keyDown("a")) {
          player.x -= player.speed;
        }
        if (keyDown("d")) {
          player.x += player.speed;
        }

        if (distance(player, weapon) <= player.radius + 16) {
          weapon.active = true;
        }

        if (weapon.active) {
          picture(player.x + 80, player.y + 30, "./media/bat.png", 70, 70);
        }

        // Player image
        picture(player.x, player.y, "./media/player.png", player.width, player.height);

        if (!weapon.active) {
          picture(weapon.x, weapon.y, "./media/bat.png", 70, 70);
        }

        // Update zombie positions
        for (var i = 0; i < zombies.length; i++)
        {
          var zombie = zombies[i];
          picture(zombie.x, zombie.y, "./media/zombie.png", zombie.width, zombie.height);

          // Update zombie position -> player
          if (zombie.x < player.x)
            zombie.x += zombie.speed;
          else zombie.x -= zombie.speed;
          if (zombie.y < player.y)
            zombie.y += zombie.speed;
          else zombie.y -= zombie.speed;

          // Check for collision with player
          if (distance(player, zombie) <= player.radius + zombie.radius) {
            alert("Game Over");
            stopUpdate();
          }
        }

        // Check if space key is pressed and weapon is ready to be used
        if (weapon.active && keyDown(" ") && Date.now() - lastUsedTime > 500) {
          // Set last used time to current time
          lastUsedTime = Date.now();
          
            // Check for collision with zombies
            for (var i = 0; i < zombies.length; i++) {
              var zombie = zombies[i];
              if (distance(player, zombie) <= player.radius + zombie.radius + 100) { // 50 is the radius for killing zombies
                // Remove the zombie from the array
                zombies.splice(i, 1);
                i--;

                // Play the sound effect
                var splatSound = new Audio("./media/splat.mp3");
                splatSound.play();

                // Display bloodsplat image
                picture(zombie.x, zombie.y, "./media/bloodsplat.png", 120, 120);

                // Get the bloodsplat image element and fade it in
                var bloodsplatImg = document.querySelector("img[src='./media/bloodsplat.png']");
                if (bloodsplatImg) {
                  bloodsplatImg.style.transition = "opacity 1s ease-in-out";
                  bloodsplatImg.style.opacity = 1;

                  // Fade out the image after 2 seconds
                  setTimeout(function() {
                    bloodsplatImg.style.opacity = 1000;
                  }, 2000);

                  // Gradually decrease opacity to 0 over 1 second
                  setTimeout(function() {
                    var opacity = 1;
                    setInterval(function() {
                      opacity -= 0.1;
                      bloodsplatImg.style.opacity = opacity;
                      if (opacity <= 0) {
                        clearInterval();
                      }
                    }, 100);
                  }, 1000);
                }
              }
            }
          }

        }

        // Used ChatGPT for this. It was my last resort. Didn't know how to make it work
        function distance(obj1, obj2) {
          var dx = obj1.x - obj2.x;
          var dy = obj1.y - obj2.y;
          var distance = Math.sqrt(dx * dx + dy * dy);
          return distance;
        }
        
      </script>
</body>
